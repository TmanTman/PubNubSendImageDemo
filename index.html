<!DOCTYPE html>
<html>
<head>
	<meta charset=”utf-8”>
	<!-- compiled and minified CSS -->
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
	
	<!-- PubNub! -->
	<script src=http://cdn.pubnub.com/pubnub.min.js ></script>
</head>
<body>

<div class="text-center">
	<h1>Send an Image With PubNub</h1><br><br>
</div>
<div class="text-center">
	<div class="col-md-4">
		Camera:<br>
		<video id="video" width="240" height="180" autoplay></video><br>
		<img id="defaultImg" />
		<button id="snap">Snap Photo</button>
	</div>
	<div class="col-md-4">
		Captured Image:<br>
		<canvas id="canvas" width="240" height="180"></canvas>
	</div>
	<div class="col-md-4">
		Image Sent Over PubNub:<br>
		<img id="output" />
	</div>
</div>
<script>

//Check for getUserMedia()
function hasGetUserMedia() {
  return !!(navigator.getUserMedia || navigator.webkitGetUserMedia ||
            navigator.mozGetUserMedia || navigator.msGetUserMedia);
}

//Compress beneath max message size in kb. Returns null if compression can't get image small enough.
function compressImage(canvas, size) {
	var compression = 1.0;
	while(compression > 0.01) {
		var dataURL = canvas.toDataURL('image/jpeg', compression);
		if (dataURL.length/1012 < size) return dataURL;
		if (compression <= 0.1) {
			compression -= 0.01;
		} else {
			compression -= 0.1;
		}
	}
	return null;
}

if (hasGetUserMedia()) {
  console.log("We're good to go!")
	var def = document.getElementById("defaultImg");
	def.src = 'http://s3.amazonaws.com/pubnub/PubNub-Zombie-Apocalypse.jpg';
	pubnub = PUBNUB.init({
		publish_key   : 'demo',
		subscribe_key : 'demo',
		origin        : 'pubsub.pubnub.com',
		ssl           : true
	});
	//Subscribe to image-demo channel
	pubnub.subscribe({
		channel : "image-demo",
		message : function(m){ //On receipt of a message, interpret it as a Base-64 encoded image and display it on page.
			var image = document.getElementById("output");
			image.src = m;
		},
		error   : function(error) {console.log(error)}
	});
} else {
  alert('getUserMedia() is not supported in your browser. Using default image.');
	var def = document.getElementById("defaultImg");
	def.src = 'http://s3.amazonaws.com/pubnub/PubNub-Zombie-Apocalypse.jpg';
}

// Put event listeners into place
window.addEventListener("DOMContentLoaded", function() {
	// Grab elements, create settings, etc.
	var canvas = document.getElementById("canvas"),
	context = canvas.getContext("2d"),
	video = document.getElementById("video"),
	videoObj = { "video": true },
	errBack = function(error) {
		console.log("Video capture error: ", error.code); 
	};

	// Put video listeners into place
	if(navigator.getUserMedia) { // Standard
		navigator.getUserMedia(videoObj, function(stream) {
			video.src = stream;
			video.play();
		}, errBack);
	} else if(navigator.webkitGetUserMedia) { // WebKit-prefixed
		navigator.webkitGetUserMedia(videoObj, function(stream){
			video.src = window.webkitURL.createObjectURL(stream);
			video.play();
		}, errBack);
	} else if(navigator.mozGetUserMedia) { // Firefox-prefixed
		navigator.mozGetUserMedia(videoObj, function(stream){
			video.src = window.URL.createObjectURL(stream);
			video.play();
		}, errBack);
	}
}, false);

//Send snapshot of vido on click.
document.getElementById("snap").addEventListener("click", function() {
	var canvas = document.getElementById("canvas"),
	context = canvas.getContext("2d"),
	if (hasGetUserMedia()) {
		video = document.getElementById("video");
		context.drawImage(video, 0, 0, 240, 180);
	} else {
		def = document.getElementById("defaultImg");
		context.drawImage(def, 0, 0, 240, 180);
	}
	
	//Base064 Encode & compress below 20 kb
	var dataURL = compressImage(canvas, 20);
	
	if (dataURL == null) {
		alert("We couldn't compress the image small enough");
		return;
	}
	
	pubnub.publish({
		channel : "image-demo",
		message : dataURL,
		error   : function(error){console.log(error)}
	});
	
});

//Codepen for this project: http://codepen.io/anon/pen/LeKFD
</script>

</body>
</html> 
